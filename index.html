<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>üé® Ca√ßador de Padr√µes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Tela de In√≠cio -->
  <div id="telaInicio">
    <h1>üé® Ca√ßador de Padr√µes</h1>
    <p class="subtitulo">Descubra os padr√µes de cores e desafie sua mente!</p>
    
    <div class="menu-principal">
      <button class="btn-menu" onclick="iniciarJogo()" tabindex="1" onfocus="narrarTexto('Iniciar Jogo')">‚ñ∂Ô∏è Iniciar Jogo</button>
      <button class="btn-menu" onclick="abrirHistorico()" tabindex="2" onfocus="narrarTexto('Hist√≥rico de Partidas')">üìä Hist√≥rico de Partidas</button>
      <button class="btn-menu" onclick="abrirConfiguracoes()" tabindex="3" onfocus="narrarTexto('Configura√ß√µes')">‚öôÔ∏è Configura√ß√µes</button>
      <button class="btn-menu" onclick="abrirManual()" tabindex="4" onfocus="narrarTexto('Como Jogar')">üìñ Como Jogar</button>
      <button class="btn-menu btn-som" id="btnSom" onclick="alternarSom()" tabindex="5" onfocus="narrarTexto('Alternar Som')">üîä Som: ON</button>
    </div>
  </div>

  <!-- Modal de Configura√ß√µes -->
  <div id="modalConfiguracoes" class="modal">
    <div class="modal-conteudo">
      <span class="fechar" onclick="fecharConfiguracoes()" tabindex="0" onfocus="narrarTexto('Fechar configura√ß√µes')">&times;</span>
      <h2>‚öôÔ∏è Configura√ß√µes</h2>
      
      <div class="config-secao">
        <h3>Modo de Acessibilidade Visual</h3>
        <p>Selecione o modo adequado para daltonismo:</p>
        
        <label class="radio-label">
          <input type="radio" name="daltonismo" value="normal" checked onchange="aplicarModoCor(this.value)" onfocus="narrarTexto('Normal, sem filtro')">
          Normal (sem filtro)
        </label>
        
        <label class="radio-label">
          <input type="radio" name="daltonismo" value="protanopia" onchange="aplicarModoCor(this.value)" onfocus="narrarTexto('Protanopia, dificuldade com vermelho')">
          Protanopia (dificuldade com vermelho)
        </label>
        
        <label class="radio-label">
          <input type="radio" name="daltonismo" value="deuteranopia" onchange="aplicarModoCor(this.value)" onfocus="narrarTexto('Deuteranopia, dificuldade com verde')">
          Deuteranopia (dificuldade com verde)
        </label>
        
        <label class="radio-label">
          <input type="radio" name="daltonismo" value="tritanopia" onchange="aplicarModoCor(this.value)" onfocus="narrarTexto('Tritanopia, dificuldade com azul')">
          Tritanopia (dificuldade com azul)
        </label>
      </div>

      <div class="config-secao">
        <h3>‚ôø Modo para Defici√™ncia Visual</h3>
        <p>Ativa navega√ß√£o por teclado e narra√ß√£o por voz. O cron√¥metro ser√° desabilitado neste modo.</p>
        
        <label class="checkbox-label">
          <input type="checkbox" id="checkboxDeficienciaVisual" onchange="alternarModoDeficienciaVisual()" onfocus="narrarTexto('Ativar modo de defici√™ncia visual')">
          Ativar modo de defici√™ncia visual
        </label>
        
        <p class="info-modo-visual" id="infoModoVisual" style="display: none;">
          ‚úì Use <strong>Tab</strong> para navegar entre as op√ß√µes<br>
          ‚úì Use <strong>Enter</strong> para selecionar<br>
          ‚úì Use os <strong>Bot√µes</strong> para selecionar no modo mobile<br>
          ‚úì A voz narrar√° cada op√ß√£o e a sequ√™ncia de cores
        </p>
      </div>
      
      <button class="btn-menu" onclick="fecharConfiguracoes()" tabindex="0" onfocus="narrarTexto('Salvar configura√ß√µes')">Salvar</button>
    </div>
  </div>

  <!-- Modal de Hist√≥rico -->
  <div id="modalHistorico" class="modal">
    <div class="modal-conteudo">
      <span class="fechar" onclick="fecharHistorico()" tabindex="0" onfocus="narrarTexto('Fechar hist√≥rico')">&times;</span>
      <h2>üìä Hist√≥rico de Partidas</h2>
      
      <div id="listaHistorico" class="historico-lista">
        <!-- Ser√° preenchido dinamicamente -->
      </div>
      
      <button class="btn-menu btn-limpar" onclick="limparHistorico()" tabindex="0" onfocus="narrarTexto('Limpar Hist√≥rico')">üóëÔ∏è Limpar Hist√≥rico</button>
      <button class="btn-menu" onclick="fecharHistorico()" tabindex="0" onfocus="narrarTexto('Fechar')">Fechar</button>
    </div>
  </div>

  <!-- Modal de Manual -->
  <div id="modalManual" class="modal">
    <div class="modal-conteudo">
      <span class="fechar" onclick="fecharManual()" tabindex="0" onfocus="narrarTexto('Fechar manual')">&times;</span>
      <h2>üìñ Como Jogar</h2>
      
      <div class="manual-texto">
        <h3>üéØ Objetivo</h3>
        <p>Identifique o padr√£o na sequ√™ncia de cores e escolha qual cor vem a seguir!</p>
        
        <h3>üéÆ Como Funciona</h3>
        <ul>
          <li>Observe atentamente a sequ√™ncia de blocos coloridos</li>
          <li>Identifique o padr√£o de repeti√ß√£o das cores</li>
          <li>Clique na cor que voc√™ acha que vem a seguir</li>
          <li>Ganhe pontos por acertar!</li>
          <li><strong>CUIDADO:</strong> Voc√™ tem apenas 3 vidas (‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è)</li>
          <li>Cada erro faz voc√™ perder uma vida</li>
          <li>Se perder todas as vidas, o jogo termina!</li>
        </ul>
        
        <h3>üìä N√≠veis e Rodadas</h3>
        <ul>
          <li><strong>N√≠vel 1 (F√°cil):</strong> 2 cores, 5-9 blocos, 3 op√ß√µes - Complete 7 rodadas para avan√ßar</li>
          <li><strong>N√≠vel 2 (M√©dio):</strong> 5 cores, 7-13 blocos, 5 op√ß√µes - Complete 10 rodadas para avan√ßar</li>
          <li><strong>N√≠vel 3 (Dif√≠cil):</strong> 7 cores, 9-15 blocos, 7 op√ß√µes - Complete 10 rodadas para vencer!</li>
        </ul>
        
        <h3>üèÜ Pontua√ß√£o</h3>
        <ul>
          <li>Cada acerto = 1 ponto</li>
          <li>N√≠vel 1: ~7 pontos (se n√£o errar)</li>
          <li>N√≠vel 2: ~10 pontos (se n√£o errar)</li>
          <li>N√≠vel 3: ~10 pontos (se n√£o errar)</li>
          <li><strong>Pontua√ß√£o m√°xima: ~27 pontos completando todos os n√≠veis!</strong></li>
          <li>Seu hist√≥rico de partidas √© salvo automaticamente</li>
        </ul>
        
        <h3>‚ö° Mec√¢nica R√°pida</h3>
        <p>O jogo avan√ßa automaticamente ap√≥s sua escolha! Seja r√°pido e preciso!</p>
        
        <h3>‚è±Ô∏è Cron√¥metro</h3>
        <p>Voc√™ tem 60 segundos por n√≠vel! O tempo √© resetado quando voc√™ avan√ßa de n√≠vel.</p>
        
        <h3>üîä Sons e Efeitos</h3>
        <p>O jogo possui efeitos sonoros para acertos, erros e mudan√ßas de n√≠vel. Voc√™ pode ativar/desativar no menu principal!</p>
        
        <h3>‚ôø Acessibilidade</h3>
        <p>Use as configura√ß√µes para ativar modos especiais para daltonismo!</p>
        <p>e tambem para deficientes visuais!</p>
      </div>
      
      <button class="btn-menu" onclick="fecharManual()" tabindex="0" onfocus="narrarTexto('Entendi, fechar manual')">Entendi!</button>
    </div>
  </div>

  <!-- √Årea do Jogo -->
  <div id="areaJogo" style="display: none;">

    <div id="nivel">N√≠vel: 1 (F√°cil)</div>
    <div id="vidas">‚ù§Ô∏è ‚ù§Ô∏è ‚ù§Ô∏è</div>
    <div id="cronometro">‚è±Ô∏è Tempo: 60s</div>
    <div id="notificacao" class="notificacao-nivel"></div>
    <div class="rotulo-area rotulo-sequencia" aria-hidden="true">Sequ√™ncia</div>
    <div id="sequencia"></div>
    <div class="divisor-areas" aria-hidden="true"></div>
    <div class="rotulo-area rotulo-respostas" aria-hidden="true">Respostas</div>
    <div id="opcoes"></div>

    <div id="feedback"></div>
    <div id="pontos">Pontos: 0</div>

    <button class="btn-voltar" onclick="voltarMenu()" tabindex="20" onfocus="narrarTexto('Voltar ao Menu')">üè† Voltar ao Menu</button>
  </div>

  <!-- Modal de Game Over -->
  <div id="modalGameOver" class="modal">
    <div class="modal-conteudo modal-gameover">
      <h2 id="tituloGameOver">‚è∞ Tempo Esgotado!</h2>
      <div class="gameover-stats">
        <p class="stat-item">üéØ <strong>Pontua√ß√£o Final:</strong> <span id="pontosFinal">0</span> pontos</p>
        <p class="stat-item">üìä <strong>N√≠vel Alcan√ßado:</strong> <span id="nivelFinal">1</span></p>
      </div>
      <p class="gameover-mensagem">üéÆ Tente novamente e supere seu recorde!</p>
      <button class="btn-menu btn-gameover" onclick="fecharGameOver()" tabindex="0" onfocus="narrarTexto('Voltar ao Menu Principal')">Voltar ao Menu</button>
    </div>
  </div>

  <!-- Controles m√≥veis para acessibilidade (dispon√≠veis em todas as telas) -->
  <div id="controlesAcessibilidadeMobile" class="controles-acessibilidade-mobile" aria-hidden="true">
    <button id="btnOpcaoAnterior" class="btn-acc-nav" type="button" onclick="navegarOpcao(-1)" onfocus="narrarTexto('Op√ß√£o anterior')">‚óÄ Op√ß√£o anterior</button>
    <button id="btnConfirmarOpcao" class="btn-acc-confirmar" type="button" onclick="confirmarOpcaoSelecionada()" onfocus="narrarTexto('Confirmar op√ß√£o selecionada')">‚úÖ Confirmar</button>
    <button id="btnOpcaoProxima" class="btn-acc-nav" type="button" onclick="navegarOpcao(1)" onfocus="narrarTexto('Pr√≥xima op√ß√£o')">‚ñ∂ Op√ß√£o seguinte</button>
  </div>

  <script>
    const cores = ["red", "yellow", "blue", "green", "orange", "purple", "pink"];
    let coresAtuais = {...cores};
    let modoCor = "normal";
    let padrao = [];
    let proximaCor = "";
  let pontos = 0;
  let nivel = 1;
  let vidas = 3;
  let rodadasPorNivel = 0; // Contador de rodadas no n√≠vel atual
  // Hist√≥rico de partidas (carrega do localStorage se existir)
  let historicoPartidas = JSON.parse(localStorage.getItem('historicoPartidas')) || [];
  // Acumulador de pontua√ß√£o por n√≠veis (cada n√≠vel conclu√≠do = +33)
  let levelAccum = 0;
  let tempoRestante = 60;
    let intervaloTempo = null;
    let jogoAtivo = false;
    let somAtivado = true;
    let musicaAtivada = false;
    let modoDeficienciaVisual = false; // Modo de acessibilidade para deficientes visuais
    let navegacaoAcessibilidadeHabilitada = false; // controla se navega√ß√£o via controles m√≥veis est√° ativa
    let indiceOpcaoFocada = 0; // √≠ndice da op√ß√£o atual para navega√ß√£o
    let corSelecionada = null; // cor escolhida pelo usu√°rio (ap√≥s confirma√ß√£o)
    let elementoSelecionado = null; // elemento atual selecionado via controles
    let rodadaTravada = false; // evita m√∫ltiplas confirma√ß√µes na mesma rodada

    // Contexto de √°udio
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    // Mapeamento de cores para portugu√™s
    const coresEmPortugues = {
      red: "vermelho",
      yellow: "amarelo",
      blue: "azul",
      green: "verde",
      orange: "laranja",
      purple: "roxo",
      pink: "rosa"
    };

    // Fun√ß√µes de Som
    function tocarSomAcerto() {
      if (!somAtivado) return;
      
      const oscilador = audioContext.createOscillator();
      const ganho = audioContext.createGain();
      
      oscilador.connect(ganho);
      ganho.connect(audioContext.destination);
      
      // Som ascendente agrad√°vel (sucesso)
      oscilador.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
      oscilador.frequency.exponentialRampToValueAtTime(783.99, audioContext.currentTime + 0.1); // G5
      
      oscilador.type = 'sine';
      ganho.gain.setValueAtTime(0.3, audioContext.currentTime);
      ganho.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      
      oscilador.start(audioContext.currentTime);
      oscilador.stop(audioContext.currentTime + 0.3);
    }

    function tocarSomErro() {
      if (!somAtivado) return;
      
      const oscilador = audioContext.createOscillator();
      const ganho = audioContext.createGain();
      
      oscilador.connect(ganho);
      ganho.connect(audioContext.destination);
      
      // Som descendente (erro)
      oscilador.frequency.setValueAtTime(300, audioContext.currentTime);
      oscilador.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.2);
      
      oscilador.type = 'sawtooth';
      ganho.gain.setValueAtTime(0.2, audioContext.currentTime);
      ganho.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
      
      oscilador.start(audioContext.currentTime);
      oscilador.stop(audioContext.currentTime + 0.2);
    }

    function tocarSomNivel() {
      if (!somAtivado) return;
      
      // Melodia de celebra√ß√£o
      const notas = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
      
      notas.forEach((frequencia, index) => {
        const oscilador = audioContext.createOscillator();
        const ganho = audioContext.createGain();
        
        oscilador.connect(ganho);
        ganho.connect(audioContext.destination);
        
        oscilador.frequency.setValueAtTime(frequencia, audioContext.currentTime + index * 0.15);
        oscilador.type = 'triangle';
        
        ganho.gain.setValueAtTime(0.3, audioContext.currentTime + index * 0.15);
        ganho.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.15 + 0.3);
        
        oscilador.start(audioContext.currentTime + index * 0.15);
        oscilador.stop(audioContext.currentTime + index * 0.15 + 0.3);
      });
    }

    function tocarSomClick() {
      if (!somAtivado) return;
      
      const oscilador = audioContext.createOscillator();
      const ganho = audioContext.createGain();
      
      oscilador.connect(ganho);
      ganho.connect(audioContext.destination);
      
      oscilador.frequency.setValueAtTime(800, audioContext.currentTime);
      oscilador.type = 'square';
      
      ganho.gain.setValueAtTime(0.1, audioContext.currentTime);
      ganho.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
      
      oscilador.start(audioContext.currentTime);
      oscilador.stop(audioContext.currentTime + 0.05);
    }

    function tocarSomGameOver() {
      if (!somAtivado) return;
      
      // Som de game over dram√°tico
      const notas = [392, 370, 349, 330, 294]; // G, F#, F, E, D
      
      notas.forEach((frequencia, index) => {
        const oscilador = audioContext.createOscillator();
        const ganho = audioContext.createGain();
        
        oscilador.connect(ganho);
        ganho.connect(audioContext.destination);
        
        oscilador.frequency.setValueAtTime(frequencia, audioContext.currentTime + index * 0.2);
        oscilador.type = 'sine';
        
        ganho.gain.setValueAtTime(0.3, audioContext.currentTime + index * 0.2);
        ganho.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.2 + 0.4);
        
        oscilador.start(audioContext.currentTime + index * 0.2);
        oscilador.stop(audioContext.currentTime + index * 0.2 + 0.4);
      });
    }

    function alternarSom() {
      somAtivado = !somAtivado;
      const botao = document.getElementById("btnSom");
      botao.textContent = somAtivado ? "üîä Som: ON" : "üîá Som: OFF";
      tocarSomClick();
    }

    // ===== FUN√á√ïES DE NARRA√á√ÉO POR VOZ (Web Speech API) =====
    
    function removerEmojis(texto) {
      // Remove emojis e outros s√≠mbolos Unicode especiais
      return texto.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F000}-\u{1F02F}]|[\u{1F0A0}-\u{1F0FF}]|[\u{1F100}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{1F910}-\u{1F96B}]|[\u{1F980}-\u{1F9E0}]/gu, '').trim();
    }

    function narrarTexto(texto, callback) {
      if (!modoDeficienciaVisual) return;
      
      // Remover emojis do texto antes de narrar
      const textoLimpo = removerEmojis(texto);
      if (!textoLimpo) return; // Se ap√≥s remover emojis n√£o sobrou nada, n√£o narrar
      
      // Cancelar qualquer narra√ß√£o em andamento
      window.speechSynthesis.cancel();
      
      const utterance = new SpeechSynthesisUtterance(textoLimpo);
      utterance.lang = 'pt-BR';
      utterance.rate = 0.9; // Velocidade de fala
      utterance.pitch = 1.0;
      utterance.volume = 1.0;
      
      if (callback) {
        utterance.onend = callback;
      }
      
      window.speechSynthesis.speak(utterance);
    }

    function narrarCor(cor) {
      if (!modoDeficienciaVisual) return;
      const corPortugues = coresEmPortugues[cor] || cor;
      narrarTexto(corPortugues);
    }

    function narrarSequencia(sequencia) {
      if (!modoDeficienciaVisual) return;
      
      const coresNomes = sequencia.map(cor => coresEmPortugues[cor] || cor);
      const texto = "Sequ√™ncia de cores: " + coresNomes.join(", ") + ". Agora escolha a pr√≥xima cor.";
      
      // Ap√≥s terminar a narra√ß√£o, habilitar os bot√µes
      narrarTexto(texto, habilitarBotoesResposta);
    }

    function habilitarBotoesResposta() {
      if (!modoDeficienciaVisual) return;
      
      const botoesOpcoes = document.querySelectorAll(".botao-cor");
      botoesOpcoes.forEach((btn, index) => {
        btn.setAttribute("tabindex", 10 + index);
        btn.style.pointerEvents = "auto";
        btn.classList.remove("botao-desabilitado");
      });

      // Resetar vari√°veis ANTES de habilitar navega√ß√£o
      corSelecionada = null;
      elementoSelecionado = null;
      indiceOpcaoFocada = 0;
      
      // Agora habilitar a navega√ß√£o
      navegacaoAcessibilidadeHabilitada = true;
      
      // Habilitar tamb√©m o bot√£o "Voltar ao Menu"
      const btnVoltar = document.querySelector('.btn-voltar');
      if (btnVoltar) {
        btnVoltar.setAttribute("tabindex", "20");
        btnVoltar.style.pointerEvents = "auto";
        btnVoltar.style.opacity = "1";
      }
      
      // Focar e selecionar o primeiro bot√£o automaticamente
      setTimeout(() => {
        const primeiroBotao = document.querySelector('.botao-cor');
        if (primeiroBotao) {
          primeiroBotao.focus();
          // Selecionar automaticamente a primeira op√ß√£o
          limparSelecaoAnterior();
          elementoSelecionado = primeiroBotao;
          const cor = primeiroBotao.getAttribute("data-cor");
          if (cor) {
            corSelecionada = cor;
            primeiroBotao.classList.add("botao-selecionado");
            narrarTexto(`${coresEmPortugues[cor]}. Toque confirmar para escolher.`);
          }
        }
        // Atualizar controles DEPOIS de selecionar
        atualizarControlesAcessibilidadeMobile();
      }, 100);
    }

    function alternarModoDeficienciaVisual() {
      const checkbox = document.getElementById("checkboxDeficienciaVisual");
      const info = document.getElementById("infoModoVisual");
      
      modoDeficienciaVisual = checkbox.checked;
      info.style.display = modoDeficienciaVisual ? "block" : "none";
      
      // Salvar prefer√™ncia no localStorage
      localStorage.setItem('modoDeficienciaVisual', modoDeficienciaVisual);
      
      if (modoDeficienciaVisual) {
        narrarTexto("Modo de defici√™ncia visual ativado. Use Tab para navegar e Enter para selecionar.");
        atualizarControlesAcessibilidadeMobile();
      } else {
        window.speechSynthesis.cancel();
        atualizarControlesAcessibilidadeMobile();
      }
    }

    // Carregar prefer√™ncia salva ao iniciar
    function carregarPreferenciasAcessibilidade() {
      const preferenciaSalva = localStorage.getItem('modoDeficienciaVisual');
      if (preferenciaSalva === 'true') {
        modoDeficienciaVisual = true;
        const checkbox = document.getElementById("checkboxDeficienciaVisual");
        const info = document.getElementById("infoModoVisual");
        if (checkbox) checkbox.checked = true;
        if (info) info.style.display = "block";
      }
    }

    // Carregar prefer√™ncias quando a p√°gina carregar
    window.addEventListener('DOMContentLoaded', () => {
      carregarHistorico();
      carregarPreferenciasAcessibilidade();
      atualizarControlesAcessibilidadeMobile();
      
      // Se modo visual estiver ativo e for mobile, selecionar primeiro bot√£o
      if (modoDeficienciaVisual && isMobileViewport()) {
        setTimeout(() => {
          const primeiroBotao = document.querySelector('.btn-menu');
          if (primeiroBotao) {
            indiceOpcaoFocada = 0;
            elementoSelecionado = primeiroBotao;
            limparSelecaoAnterior();
            primeiroBotao.classList.add("botao-selecionado");
          }
        }, 500);
      }
    });

    // Atualizar exibi√ß√£o dos controles m√≥veis ao redimensionar/orientar
    window.addEventListener('resize', atualizarControlesAcessibilidadeMobile);

    // Paletas de cores para diferentes tipos de daltonismo
    const paletasCores = {
      normal: {
        red: "#FF0000",
        yellow: "#FFFF00",
        blue: "#0000FF",
        green: "#00FF00",
        orange: "#FF8C00",
        purple: "#800080",
        pink: "#FF69B4"
      },
      protanopia: {
        red: "#C4A000",
        yellow: "#FFFF00",
        blue: "#0066CC",
        green: "#00A896",
        orange: "#E69F00",
        purple: "#5E3C99",
        pink: "#CC99CC"
      },
      deuteranopia: {
        red: "#B87333",
        yellow: "#FFD700",
        blue: "#0072B2",
        green: "#009E73",
        orange: "#E69F00",
        purple: "#6A4C93",
        pink: "#D891D8"
      },
      tritanopia: {
        red: "#CC0033",
        yellow: "#FFCCCC",
        blue: "#00CED1",
        green: "#006666",
        orange: "#FF6B6B",
        purple: "#CC0066",
        pink: "#FF99CC"
      }
    };

    // Configura√ß√µes de dificuldade por n√≠vel
    function getConfigNivel(nivel) {
      switch(nivel) {
        case 1: // F√°cil
          return { 
            numCores: 2,      // 2 cores diferentes
            minBlocos: 5,     // m√≠nimo de blocos (√≠mpar para 2 cores)
            maxBlocos: 9,     // m√°ximo de blocos
            numOpcoes: 3,     // 3 op√ß√µes para escolher
            rodadasNecessarias: 7  // 7 rodadas para passar de n√≠vel
          };
        case 2: // M√©dio
          return { 
            numCores: 5,      // 5 cores diferentes
            minBlocos: 7,     // m√≠nimo de blocos (n√£o m√∫ltiplo de 3)
            maxBlocos: 13,    // m√°ximo de blocos
            numOpcoes: 5,     // 5 op√ß√µes para escolher
            rodadasNecessarias: 10  // 10 rodadas para passar de n√≠vel
          };
        case 3: // Dif√≠cil
          return { 
            numCores: 7,      // 7 cores diferentes
            minBlocos: 9,     // m√≠nimo de blocos (n√£o m√∫ltiplo de 4)
            maxBlocos: 15,    // m√°ximo de blocos
            numOpcoes: 7,     // 7 op√ß√µes para escolher
            rodadasNecessarias: 10  // 10 rodadas para passar de n√≠vel
          };
        default:
          return { numCores: 2, minBlocos: 5, maxBlocos: 9, numOpcoes: 3, rodadasNecessarias: 7 };
      }
    }

    // Fun√ß√µes do Menu
    function iniciarJogo() {
      document.getElementById("telaInicio").style.display = "none";
      document.getElementById("areaJogo").style.display = "flex";
      jogoAtivo = true;
      vidas = 3;
      rodadasPorNivel = 0;
      levelAccum = 0; // reiniciar acumulador de n√≠veis ao iniciar uma nova sess√£o
      pontos = 0;
      document.getElementById("pontos").textContent = "Pontos: 0";
      atualizarVidas();
      iniciarCronometro();
      tocarSomClick();
      
      if (modoDeficienciaVisual) {
        narrarTexto("Jogo iniciado. N√≠vel 1, F√°cil. Voc√™ tem 3 vidas.");
      }
      
      gerarPadrao();
      atualizarControlesAcessibilidadeMobile();
    }

    function voltarMenu() {
      document.getElementById("areaJogo").style.display = "none";
      document.getElementById("telaInicio").style.display = "flex";
      pararCronometro();
      resetarJogo();
      tocarSomClick();
      
      // Atualizar controles de acessibilidade mobile
      atualizarControlesAcessibilidadeMobile();
      
      if (modoDeficienciaVisual) {
        setTimeout(() => {
          narrarTexto("Voltou ao menu principal. Use Tab para navegar entre as op√ß√µes.");
          // Selecionar automaticamente o primeiro bot√£o do menu
          if (isMobileViewport()) {
            const primeiroBotao = document.querySelector('.btn-menu');
            if (primeiroBotao) {
              indiceOpcaoFocada = 0;
              elementoSelecionado = primeiroBotao;
              limparSelecaoAnterior();
              primeiroBotao.classList.add("botao-selecionado");
              const textoBtn = primeiroBotao.textContent.trim();
              narrarTexto(`${textoBtn}. Toque confirmar para selecionar.`);
            }
          }
        }, 300);
      }
    }

    function resetarJogo() {
      pontos = 0;
      nivel = 1;
      vidas = 3;
      rodadasPorNivel = 0;
      levelAccum = 0;
      tempoRestante = 60;
      jogoAtivo = false;
      rodadaTravada = false;
      document.getElementById("pontos").textContent = "Pontos: 0";
      document.getElementById("nivel").textContent = "N√≠vel: 1 (F√°cil)";
      document.getElementById("cronometro").textContent = "‚è±Ô∏è Tempo: 60s";
      document.getElementById("feedback").textContent = "";
      atualizarVidas();
      navegacaoAcessibilidadeHabilitada = false;
      corSelecionada = null;
      elementoSelecionado = null;
      atualizarControlesAcessibilidadeMobile();
    }

    // Atualizar visualiza√ß√£o das vidas
    function atualizarVidas() {
      const vidasDiv = document.getElementById("vidas");
      let vidasTexto = "";
      
      for (let i = 0; i < 3; i++) {
        if (i < vidas) {
          vidasTexto += "‚ù§Ô∏è ";
        } else {
          vidasTexto += "üñ§ ";
        }
      }
      
      vidasDiv.textContent = vidasTexto.trim();
    }

    // Salvar pontua√ß√£o no hist√≥rico. Pode passar um valor override (por exemplo pontua√ß√£o parcial por n√≠veis)
    function salvarPontuacao(pontosOverride) {
      const score = (typeof pontosOverride === 'number') ? pontosOverride : pontos;
      const dataPartida = new Date().toLocaleString('pt-BR');
      const partidaInfo = {
        pontos: score,
        nivel: nivel,
        data: dataPartida
      };
      
      historicoPartidas.push(partidaInfo);
      
      // Salvar no localStorage para persist√™ncia
      localStorage.setItem('historicoPartidas', JSON.stringify(historicoPartidas));
      
      console.log('Partida salva:', partidaInfo);
      console.log('Hist√≥rico completo:', historicoPartidas);
    }

    // Carregar hist√≥rico ao iniciar
    function carregarHistorico() {
      const historicoSalvo = localStorage.getItem('historicoPartidas');
      if (historicoSalvo) {
        historicoPartidas = JSON.parse(historicoSalvo);
        console.log('=== HIST√ìRICO DE PARTIDAS CARREGADO ===');
        console.log(`Total de partidas: ${historicoPartidas.length}`);
        if (historicoPartidas.length > 0) {
          console.table(historicoPartidas);
        }
      }
    }

    // Fun√ß√µes do Cron√¥metro
    function iniciarCronometro() {
      pararCronometro();
      tempoRestante = 60;
      atualizarCronometro();
      
      // Se o modo de defici√™ncia visual estiver ativo, n√£o iniciar o cron√¥metro
      if (modoDeficienciaVisual) {
        const cronometroElement = document.getElementById("cronometro");
        cronometroElement.textContent = "‚è±Ô∏è Tempo: ‚àû (desabilitado no modo visual)";
        cronometroElement.style.color = "#888";
        return;
      }
      
      intervaloTempo = setInterval(() => {
        if (jogoAtivo) {
          tempoRestante--;
          atualizarCronometro();
          
          if (tempoRestante <= 0) {
            fimDeJogo();
          }
        }
      }, 1000);
    }

    function pararCronometro() {
      if (intervaloTempo) {
        clearInterval(intervaloTempo);
        intervaloTempo = null;
      }
    }

    function atualizarCronometro() {
      const cronometroElement = document.getElementById("cronometro");
      cronometroElement.textContent = `‚è±Ô∏è Tempo: ${tempoRestante}s`;
      
      // Mudar cor baseado no tempo restante
      if (tempoRestante <= 10) {
        cronometroElement.style.color = "#dc3545"; // Vermelho
        cronometroElement.style.fontWeight = "bold";
      } else if (tempoRestante <= 30) {
        cronometroElement.style.color = "#ff8c00"; // Laranja
      } else {
        cronometroElement.style.color = "#ffffff"; // Verde
      }
    }

    function fimDeJogo(motivo = "tempo") {
      jogoAtivo = false;
      pararCronometro();
      
      // Ao terminar o jogo (por tempo ou por perder vidas), salvar a pontua√ß√£o parcial baseada em n√≠veis conclu√≠dos
      // Se o jogador n√£o completou nenhum n√≠vel, levelAccum ser√° 0
      pontos = levelAccum;
      salvarPontuacao(levelAccum);
      
      // Desabilitar bot√µes
      const botoesOpcoes = document.querySelectorAll(".botao-cor");
      botoesOpcoes.forEach(btn => btn.style.pointerEvents = "none");
      navegacaoAcessibilidadeHabilitada = false;
      elementoSelecionado = null;
      atualizarControlesAcessibilidadeMobile();
      
      tocarSomGameOver();
      
      // Narrar fim de jogo
      if (modoDeficienciaVisual) {
        const mensagem = motivo === "vidas" 
          ? `Fim de jogo! Voc√™ perdeu todas as vidas. Pontua√ß√£o final: ${pontos} pontos.`
          : `Tempo esgotado! Fim de jogo. Pontua√ß√£o final: ${pontos} pontos.`;
        narrarTexto(mensagem);
      }
      
      setTimeout(() => {
        mostrarModalGameOver(motivo);
      }, 1000);
    }

    function mostrarModalGameOver(motivo = "tempo") {
      const tituloGameOver = document.getElementById("tituloGameOver");
      
      if (motivo === "vidas") {
        tituloGameOver.textContent = "üíî Sem Vidas!";
      } else {
        tituloGameOver.textContent = "‚è∞ Tempo Esgotado!";
      }
      
      document.getElementById("pontosFinal").textContent = pontos;
      document.getElementById("nivelFinal").textContent = nivel;
      document.getElementById("modalGameOver").style.display = "flex";
      
      // Narrar informa√ß√µes do game over
      if (modoDeficienciaVisual) {
        const mensagemTitulo = motivo === "vidas" ? "Sem vidas" : "Tempo esgotado";
        setTimeout(() => {
          narrarTexto(`${mensagemTitulo}. Pontua√ß√£o final: ${pontos} pontos. N√≠vel alcan√ßado: ${nivel}. Use Tab para navegar.`);
        }, 500);
      }
    }

    function fecharGameOver() {
      document.getElementById("modalGameOver").style.display = "none";
      tocarSomClick();
      voltarMenu();
    }

    function abrirConfiguracoes() {
      document.getElementById("modalConfiguracoes").style.display = "flex";
      tocarSomClick();
      
      if (modoDeficienciaVisual) {
        setTimeout(() => {
          narrarTexto("Configura√ß√µes abertas. Use Tab para navegar entre as op√ß√µes.");
          
          // Se estiver em mobile, resetar navega√ß√£o e selecionar primeiro elemento
          if (isMobileViewport()) {
            const elementos = obterElementosNavegacao();
            if (elementos.length > 0) {
              indiceAtualNavegacao = 0;
              selecionarElemento(elementos[0]);
            }
          }
        }, 300);
      }
    }

    function fecharConfiguracoes() {
      document.getElementById("modalConfiguracoes").style.display = "none";
      tocarSomClick();
      
      // Se estiver em mobile e modo acessibilidade, resetar navega√ß√£o para o contexto anterior
      if (modoDeficienciaVisual && isMobileViewport()) {
        setTimeout(() => {
          const elementos = obterElementosNavegacao();
          if (elementos.length > 0) {
            indiceAtualNavegacao = 0;
            selecionarElemento(elementos[0]);
          }
        }, 100);
      }
    }

    function abrirManual() {
      document.getElementById("modalManual").style.display = "flex";
      tocarSomClick();
      
      if (modoDeficienciaVisual) {
        setTimeout(() => {
          narrarTexto("Manual de instru√ß√µes aberto. Use Tab para navegar.");
          
          // Se estiver em mobile, resetar navega√ß√£o e selecionar primeiro elemento
          if (isMobileViewport()) {
            const elementos = obterElementosNavegacao();
            if (elementos.length > 0) {
              indiceAtualNavegacao = 0;
              selecionarElemento(elementos[0]);
            }
          }
        }, 300);
      }
    }

    function fecharManual() {
      document.getElementById("modalManual").style.display = "none";
      tocarSomClick();
      
      // Se estiver em mobile e modo acessibilidade, resetar navega√ß√£o para o contexto anterior
      if (modoDeficienciaVisual && isMobileViewport()) {
        setTimeout(() => {
          const elementos = obterElementosNavegacao();
          if (elementos.length > 0) {
            indiceAtualNavegacao = 0;
            selecionarElemento(elementos[0]);
          }
        }, 100);
      }
    }

    function abrirHistorico() {
      const modal = document.getElementById("modalHistorico");
      const listaDiv = document.getElementById("listaHistorico");
      
      if (historicoPartidas.length === 0) {
        listaDiv.innerHTML = '<p class="sem-historico">Nenhuma partida jogada ainda. Jogue para ver seu hist√≥rico!</p>';
      } else {
        let html = '<div class="historico-grid">';
        
        // Mostrar do mais recente ao mais antigo
        for (let i = historicoPartidas.length - 1; i >= 0; i--) {
          const partida = historicoPartidas[i];
          const nivelTexto = partida.nivel === 1 ? "F√°cil" : partida.nivel === 2 ? "M√©dio" : "Dif√≠cil";
          
          html += `
            <div class="historico-item">
              <div class="historico-header">
                <span class="historico-numero">#${i + 1}</span>
                <span class="historico-data">${partida.data}</span>
              </div>
              <div class="historico-stats">
                <div class="stat">
                  <span class="stat-label">Pontos:</span>
                  <span class="stat-valor pontos">${partida.pontos}</span>
                </div>
                <div class="stat">
                  <span class="stat-label">N√≠vel:</span>
                  <span class="stat-valor nivel">${nivelTexto}</span>
                </div>
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        listaDiv.innerHTML = html;
      }
      
      modal.style.display = "flex";
      tocarSomClick();
      
      if (modoDeficienciaVisual) {
        setTimeout(() => {
          const mensagem = historicoPartidas.length === 0 
            ? "Hist√≥rico de partidas vazio. Nenhuma partida jogada ainda."
            : `Hist√≥rico de partidas. Total de ${historicoPartidas.length} partida${historicoPartidas.length > 1 ? 's' : ''} salva${historicoPartidas.length > 1 ? 's' : ''}. Use Tab para navegar.`;
          narrarTexto(mensagem);
          
          // Se estiver em mobile, resetar navega√ß√£o e selecionar primeiro elemento
          if (isMobileViewport()) {
            const elementos = obterElementosNavegacao();
            if (elementos.length > 0) {
      
      // Se estiver em mobile e modo acessibilidade, resetar navega√ß√£o para o contexto anterior
      if (modoDeficienciaVisual && isMobileViewport()) {
        setTimeout(() => {
          const elementos = obterElementosNavegacao();
          if (elementos.length > 0) {
            indiceAtualNavegacao = 0;
            selecionarElemento(elementos[0]);
          }
        }, 100);
      }
              indiceAtualNavegacao = 0;
              selecionarElemento(elementos[0]);
            }
          }
        }, 300);
      }
    }

    function fecharHistorico() {
      document.getElementById("modalHistorico").style.display = "none";
      tocarSomClick();
    }

    function limparHistorico() {
      if (confirm("Tem certeza que deseja limpar todo o hist√≥rico de partidas?")) {
        historicoPartidas = [];
        localStorage.removeItem('historicoPartidas');
        
        if (modoDeficienciaVisual) {
          narrarTexto("Hist√≥rico limpo com sucesso.");
        }
        
        abrirHistorico(); // Atualizar a visualiza√ß√£o
        tocarSomClick();
      }
    }

    function aplicarModoCor(modo) {
      modoCor = modo;
      const paleta = paletasCores[modo];
      
      // Atualizar cores no CSS usando vari√°veis CSS
      document.documentElement.style.setProperty('--cor-red', paleta.red);
      document.documentElement.style.setProperty('--cor-yellow', paleta.yellow);
      document.documentElement.style.setProperty('--cor-blue', paleta.blue);
      document.documentElement.style.setProperty('--cor-green', paleta.green);
      document.documentElement.style.setProperty('--cor-orange', paleta.orange);
      document.documentElement.style.setProperty('--cor-purple', paleta.purple);
      document.documentElement.style.setProperty('--cor-pink', paleta.pink);
    }

    // Inicializar cores normais
    aplicarModoCor("normal");

    function gerarPadrao() {
      padrao = [];
      rodadaTravada = false;
      const config = getConfigNivel(nivel);
      const coresEscolhidas = [];

      // escolher cores diferentes baseado no n√≠vel
      while (coresEscolhidas.length < config.numCores) {
        const cor = cores[Math.floor(Math.random() * cores.length)];
        if (!coresEscolhidas.includes(cor)) coresEscolhidas.push(cor);
      }

      // N√∫mero aleat√≥rio de blocos para evitar que o padr√£o sempre "feche"
      const numBlocos = Math.floor(Math.random() * (config.maxBlocos - config.minBlocos + 1)) + config.minBlocos;
      
      // Gerar a sequ√™ncia de blocos
      for (let i = 0; i < numBlocos; i++) {
        padrao.push(coresEscolhidas[i % config.numCores]);
      }

      // A pr√≥xima cor continua o padr√£o
      proximaCor = coresEscolhidas[numBlocos % config.numCores];
      
      mostrarPadrao();
      mostrarOpcoes();
      navegacaoAcessibilidadeHabilitada = false;
      corSelecionada = null;
      elementoSelecionado = null;
      atualizarControlesAcessibilidadeMobile();
      
      // Narrar a sequ√™ncia se modo visual estiver ativo
      if (modoDeficienciaVisual) {
        setTimeout(() => {
          narrarSequencia(padrao);
        }, 500);
      }
    }

    function mostrarPadrao() {
      const container = document.getElementById("sequencia");
      container.innerHTML = "";
      padrao.forEach(cor => {
        const bloco = document.createElement("div");
        bloco.classList.add("bloco");
        bloco.setAttribute("data-cor", cor);
        container.appendChild(bloco);
      });
    }

    function mostrarOpcoes() {
      const opcoesDiv = document.getElementById("opcoes");
      opcoesDiv.innerHTML = "";
      const config = getConfigNivel(nivel);

      const opcoesAleatorias = [...cores]
        .sort(() => Math.random() - 0.5)
        .slice(0, config.numOpcoes);

      if (!opcoesAleatorias.includes(proximaCor)) {
        opcoesAleatorias[Math.floor(Math.random() * config.numOpcoes)] = proximaCor;
      }

      opcoesAleatorias.forEach((cor, index) => {
        const btn = document.createElement("div");
        btn.classList.add("botao-cor");
        btn.setAttribute("data-cor", cor);
        btn.setAttribute("role", "button");
        btn.setAttribute("aria-label", coresEmPortugues[cor]);
        
        // Se modo visual estiver ativo, desabilitar inicialmente
        if (modoDeficienciaVisual) {
          btn.setAttribute("tabindex", "-1"); // Desabilita navega√ß√£o por Tab
          btn.style.pointerEvents = "none"; // Desabilita cliques
          btn.classList.add("botao-desabilitado");
        } else {
          btn.setAttribute("tabindex", 10 + index);
        }
        
        // Eventos de clique / sele√ß√£o
        if (modoDeficienciaVisual) {
          btn.addEventListener("click", () => selecionarElemento(btn));
        } else {
          btn.addEventListener("click", () => verificar(cor));
        }
        
        // Navega√ß√£o por teclado
        btn.addEventListener("focus", () => {
          narrarCor(cor);
        });
        
        btn.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            if (modoDeficienciaVisual) {
              // Em desktop: Enter primeiro seleciona (narra), Enter novamente confirma
              if (!isMobileViewport()) {
                if (elementoSelecionado === btn && corSelecionada === cor) {
                  verificar(cor);
                } else {
                  selecionarElemento(btn);
                }
              } else {
                selecionarElemento(btn);
              }
            } else {
              verificar(cor);
            }
          }
        });
        
        opcoesDiv.appendChild(btn);
      });
      
      // Desabilitar tamb√©m o bot√£o "Voltar ao Menu" se modo visual estiver ativo
      if (modoDeficienciaVisual) {
        const btnVoltar = document.querySelector('.btn-voltar');
        if (btnVoltar) {
          btnVoltar.setAttribute("tabindex", "-1");
          btnVoltar.style.pointerEvents = "none";
          btnVoltar.style.opacity = "0.5";
        }
      }
    }

    function verificar(cor) {
      if (!jogoAtivo || rodadaTravada) return; // Ignorar cliques se o jogo n√£o estiver ativo ou j√° processado
      
      const feedback = document.getElementById("feedback");
      
      // Desabilitar bot√µes temporariamente
      const botoesOpcoes = document.querySelectorAll(".botao-cor");
      botoesOpcoes.forEach(btn => btn.style.pointerEvents = "none");
      rodadaTravada = true;
      
      if (cor === proximaCor) {
        feedback.style.color = "green";
        feedback.textContent = "‚úÖ Muito bem! Voc√™ descobriu o padr√£o!";
        pontos++;
        tocarSomAcerto();
        narrarTexto("Correto! Muito bem!");
      } else {
        feedback.style.color = "red";
        feedback.textContent = "‚ùå Ops! Essa cor n√£o segue o padr√£o.";
        vidas--;
        atualizarVidas();
        tocarSomErro();
        narrarTexto("Incorreto. Voc√™ perdeu uma vida. Vidas restantes: " + vidas);
      }

      // Contabilizar a rodada (conte tanto acertos quanto erros como rodadas)
      rodadasPorNivel++;

      // Se perdeu todas as vidas ap√≥s esta jogada
      if (vidas <= 0) {
        feedback.textContent = "üíî Voc√™ perdeu todas as vidas!";
        setTimeout(() => {
          fimDeJogo("vidas");
        }, 2000);
        return;
      }

      document.getElementById("pontos").textContent = "Pontos: " + pontos;
      
      // Avan√ßar automaticamente ap√≥s 1.5 segundos
      setTimeout(() => {
        if (jogoAtivo) {
          novaRodada();
        }
      }, 1500);
    }

    // ===== Navega√ß√£o e confirma√ß√£o no modo de acessibilidade =====
    function isMobileViewport() {
      return window.innerWidth <= 820 && window.innerHeight <= 900;
    }

    function atualizarControlesAcessibilidadeMobile() {
      const container = document.getElementById("controlesAcessibilidadeMobile");
      if (!container) return;
      
      // Mostrar controles se modo visual ativo, mobile e (no jogo OU no menu principal)
      const telaInicioVisivel = document.getElementById("telaInicio").style.display !== "none";
      const deveMostrar = modoDeficienciaVisual && isMobileViewport() && (jogoAtivo || telaInicioVisivel);
      
      container.style.display = deveMostrar ? "flex" : "none";
      container.setAttribute("aria-hidden", deveMostrar ? "false" : "true");

      const botoesControladores = container.querySelectorAll("button");
      botoesControladores.forEach(btn => {
        // Habilitar bot√µes se estiver no jogo com navega√ß√£o habilitada OU se estiver no menu
        const habilitar = deveMostrar && (navegacaoAcessibilidadeHabilitada || telaInicioVisivel);
        btn.disabled = !habilitar;
      });
    }

    function obterElementosNavegacao() {
      // Verificar se h√° um modal aberto
      const modalConfiguracoes = document.getElementById("modalConfiguracoes");
      const modalHistorico = document.getElementById("modalHistorico");
      const modalManual = document.getElementById("modalManual");
      const modalGameOver = document.getElementById("modalGameOver");
      
      // Se modal de configura√ß√µes est√° aberto
      if (modalConfiguracoes && modalConfiguracoes.style.display === "flex") {
        const elementos = [];
        const modalContent = modalConfiguracoes.querySelector('.modal-conteudo');
        if (modalContent) {
          // Adicionar inputs radio de daltonismo (apenas deste modal)
          elementos.push(...Array.from(modalContent.querySelectorAll('input[type="radio"]')));
          // Adicionar checkbox de defici√™ncia visual (apenas deste modal)
          elementos.push(...Array.from(modalContent.querySelectorAll('input[type="checkbox"]')));
          // Adicionar apenas os bot√µes e fechar deste modal espec√≠fico
          const botoes = Array.from(modalContent.querySelectorAll('.btn-menu, .fechar')).filter(el => {
            // Garantir que o elemento est√° vis√≠vel e √© filho direto deste modal
            return el.closest('.modal') === modalConfiguracoes;
          });
          elementos.push(...botoes);
        }
        return elementos;
      }
      
      // Se modal de hist√≥rico est√° aberto
      if (modalHistorico && modalHistorico.style.display === "flex") {
        const elementos = [];
        const modalContent = modalHistorico.querySelector('.modal-conteudo');
        if (modalContent) {
          // Adicionar apenas os bot√µes deste modal espec√≠fico
          const botoes = Array.from(modalContent.querySelectorAll('.btn-menu, .fechar')).filter(el => {
            return el.closest('.modal') === modalHistorico;
          });
          elementos.push(...botoes);
        }
        return elementos;
      }
      
      // Se modal de manual est√° aberto
      if (modalManual && modalManual.style.display === "flex") {
        const elementos = [];
        const modalContent = modalManual.querySelector('.modal-conteudo');
        if (modalContent) {
          // Adicionar apenas os bot√µes deste modal espec√≠fico
          const botoes = Array.from(modalContent.querySelectorAll('.btn-menu, .fechar')).filter(el => {
            return el.closest('.modal') === modalManual;
          });
          elementos.push(...botoes);
        }
        return elementos;
      }
      
      // Se modal de game over est√° aberto
      if (modalGameOver && modalGameOver.style.display === "flex") {
        const elementos = [];
        const modalContent = modalGameOver.querySelector('.modal-conteudo');
        if (modalContent) {
          const botoes = Array.from(modalContent.querySelectorAll('.btn-menu')).filter(el => {
            return el.closest('.modal') === modalGameOver;
          });
          elementos.push(...botoes);
        }
        return elementos;
      }
      
      // Se estiver na tela inicial (menu principal)
      const telaInicio = document.getElementById("telaInicio");
      if (telaInicio && telaInicio.style.display !== "none") {
        // Pegar apenas os bot√µes do menu principal (n√£o dos modais)
        const menuPrincipal = telaInicio.querySelector('.menu-principal');
        if (menuPrincipal) {
          return Array.from(menuPrincipal.querySelectorAll('.btn-menu'));
        }
        return [];
      }
      
      // Se estiver no jogo, navegar pelas cores e bot√£o voltar
      const areaJogo = document.getElementById("areaJogo");
      if (areaJogo && areaJogo.style.display !== "none") {
        const elementos = Array.from(areaJogo.querySelectorAll(".botao-cor"));
        const voltar = areaJogo.querySelector('.btn-voltar');
        if (voltar) elementos.push(voltar);
        return elementos;
      }
      
      return [];
    }

    function limparSelecaoAnterior() {
      const marcados = document.querySelectorAll('.botao-selecionado');
      marcados.forEach(el => el.classList.remove('botao-selecionado'));
    }

    function selecionarElemento(elemento) {
      if (!modoDeficienciaVisual || !elemento) return;
      
      const telaInicioVisivel = document.getElementById("telaInicio").style.display !== "none";
      const modalAberto = document.querySelector('.modal[style*="display: flex"]');
      
      // Permitir sele√ß√£o no menu, no jogo com navega√ß√£o habilitada, ou em modais
      if (!telaInicioVisivel && !navegacaoAcessibilidadeHabilitada && !modalAberto) return;
      
      limparSelecaoAnterior();
      elementoSelecionado = elemento;

      const cor = elemento.getAttribute("data-cor");
      if (cor) {
        corSelecionada = cor;
        elemento.classList.add("botao-selecionado");
        narrarTexto(`${coresEmPortugues[cor]}. Toque confirmar para escolher.`);
      } else if (elemento.classList.contains('btn-voltar')) {
        corSelecionada = null;
        elemento.classList.add("botao-selecionado");
        narrarTexto("Voltar ao menu. Toque confirmar para voltar.");
      } else if (elemento.classList.contains('btn-menu')) {
        corSelecionada = null;
        elemento.classList.add("botao-selecionado");
        const textoBtn = elemento.textContent.trim();
        narrarTexto(`${textoBtn}. Toque confirmar para selecionar.`);
      } else if (elemento.classList.contains('fechar')) {
        corSelecionada = null;
        elemento.classList.add("botao-selecionado");
        narrarTexto("Fechar. Toque confirmar para fechar.");
      } else if (elemento.tagName === 'INPUT') {
        corSelecionada = null;
        // Para inputs, marcar o label pai se existir
        const label = elemento.closest('label');
        if (label) {
          label.classList.add("botao-selecionado");
        } else {
          elemento.classList.add("botao-selecionado");
        }
        
        if (elemento.type === 'radio') {
          const textoLabel = elemento.closest('label')?.textContent.trim() || elemento.value;
          narrarTexto(`${textoLabel}. Toque confirmar para selecionar.`);
        } else if (elemento.type === 'checkbox') {
          const textoLabel = elemento.closest('label')?.textContent.trim() || 'Checkbox';
          const estado = elemento.checked ? 'ativado' : 'desativado';
          narrarTexto(`${textoLabel}. Atualmente ${estado}. Toque confirmar para alternar.`);
        }
      }
    }

    function navegarOpcao(delta) {
      if (!modoDeficienciaVisual) return;
      
      const telaInicioVisivel = document.getElementById("telaInicio").style.display !== "none";
      const modalAberto = document.querySelector('.modal[style*="display: flex"]');
      
      // Permitir navega√ß√£o no menu, no jogo com navega√ß√£o habilitada, ou em modais
      if (!telaInicioVisivel && !navegacaoAcessibilidadeHabilitada && !modalAberto) return;
      
      const elementos = obterElementosNavegacao();
      if (!elementos.length) return;
      indiceOpcaoFocada = (indiceOpcaoFocada + delta + elementos.length) % elementos.length;
      const alvo = elementos[indiceOpcaoFocada];
      alvo.focus();
      selecionarElemento(alvo);
    }

    function confirmarOpcaoSelecionada() {
      if (!modoDeficienciaVisual) return;
      
      const telaInicioVisivel = document.getElementById("telaInicio").style.display !== "none";
      const modalAberto = document.querySelector('.modal[style*="display: flex"]');
      
      // Permitir confirma√ß√£o no menu, no jogo com navega√ß√£o habilitada, ou em modais
      if (!telaInicioVisivel && !navegacaoAcessibilidadeHabilitada && !modalAberto) return;
      
      if (!elementoSelecionado) {
        narrarTexto("Nenhuma op√ß√£o selecionada. Use anterior ou pr√≥ximo para escolher.");
        return;
      }

      const cor = elementoSelecionado.getAttribute("data-cor");
      if (cor) {
        verificar(cor);
      } else if (elementoSelecionado.classList.contains('btn-voltar')) {
        narrarTexto("Voltando ao menu principal.");
        elementoSelecionado.click();
      } else if (elementoSelecionado.classList.contains('btn-menu')) {
        narrarTexto("Selecionando op√ß√£o.");
        elementoSelecionado.click();
      } else if (elementoSelecionado.classList.contains('fechar')) {
        narrarTexto("Fechando.");
        elementoSelecionado.click();
      } else if (elementoSelecionado.tagName === 'INPUT') {
        if (elementoSelecionado.type === 'radio') {
          narrarTexto("Op√ß√£o selecionada.");
          elementoSelecionado.click();
        } else if (elementoSelecionado.type === 'checkbox') {
          elementoSelecionado.click();
          const estado = elementoSelecionado.checked ? 'ativado' : 'desativado';
          narrarTexto(`Alternado para ${estado}.`);
        }
      }
    }

    function novaRodada() {
      if (!jogoAtivo) return;
      
      document.getElementById("feedback").textContent = "";

      const config = getConfigNivel(nivel);

      // Verificar mudan√ßa de n√≠vel baseado nas rodadas completadas
      if (rodadasPorNivel >= config.rodadasNecessarias && nivel === 1) {
        mudarNivel(2, "N√≠vel: 2 (M√©dio)", "üéâ Parab√©ns! N√≠vel M√âDIO desbloqueado!", "Agora s√£o 5 cores com sequ√™ncias vari√°veis! Voc√™ completou 7 rodadas!");
        return;
      } else if (rodadasPorNivel >= config.rodadasNecessarias && nivel === 2) {
        mudarNivel(3, "N√≠vel: 3 (Dif√≠cil)", "üåü Incr√≠vel! N√≠vel DIF√çCIL desbloqueado!", "Agora s√£o 7 cores com sequ√™ncias mais longas! Voc√™ completou 10 rodadas!");
        return;
      } else if (rodadasPorNivel >= config.rodadasNecessarias && nivel === 3) {
        // Completou todos os n√≠veis!
        jogoVencido();
        return;
      }

      // Se n√£o mudou de n√≠vel, apenas gerar novo padr√£o
      gerarPadrao();
    }

    // Fun√ß√£o para quando o jogador completar todos os n√≠veis
    function jogoVencido() {
      jogoAtivo = false;
      pararCronometro();
      // Ao completar todos os n√≠veis, contabilizar o √∫ltimo n√≠vel (+33) e arredondar se necess√°rio
      levelAccum += 33;
      if (levelAccum === 99) levelAccum = 100; // arredondar para 100 pontos
      // Atualizar pontua√ß√£o exibida
      pontos = levelAccum;
      document.getElementById("pontos").textContent = "Pontos: " + pontos;
      // Salvar pontua√ß√£o total no hist√≥rico
      salvarPontuacao(levelAccum);

      const notificacao = document.getElementById("notificacao");
      notificacao.innerHTML = `
        <div class="notificacao-conteudo notificacao-vitoria">
          <h2>üèÜ PARAB√âNS! üèÜ</h2>
          <p>Voc√™ completou TODOS os n√≠veis!</p>
          <p class="pontos-destaque">Pontua√ß√£o Final: ${pontos} pontos</p>
          <p>Voc√™ √© um mestre dos padr√µes!</p>
          <button class="btn-menu" onclick="voltarMenuVitoria()" tabindex="0" onfocus="narrarTexto('Voltar ao Menu Principal')">Voltar ao Menu</button>
        </div>
      `;
      notificacao.style.display = "flex";
      
      // Tocar som de vit√≥ria especial
      tocarSomVitoria();
      
      // Narrar vit√≥ria
      if (modoDeficienciaVisual) {
        setTimeout(() => {
          narrarTexto(`Parab√©ns! Voc√™ completou todos os n√≠veis! Pontua√ß√£o final: ${pontos} pontos. Voc√™ √© um mestre dos padr√µes! Use Tab para navegar.`);
        }, 500);
      }
    }

    function voltarMenuVitoria() {
      document.getElementById("notificacao").style.display = "none";
      voltarMenu();
    }

    // Som de vit√≥ria especial
    function tocarSomVitoria() {
      if (!somAtivado) return;
      
      // Melodia de vit√≥ria elaborada
      const notas = [523.25, 587.33, 659.25, 783.99, 880.00, 1046.50]; // C5, D5, E5, G5, A5, C6
      
      notas.forEach((frequencia, index) => {
        const oscilador = audioContext.createOscillator();
        const ganho = audioContext.createGain();
        
        oscilador.connect(ganho);
        ganho.connect(audioContext.destination);
        
        oscilador.frequency.setValueAtTime(frequencia, audioContext.currentTime + index * 0.2);
        oscilador.type = 'sine';
        
        ganho.gain.setValueAtTime(0.4, audioContext.currentTime + index * 0.2);
        ganho.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.2 + 0.4);
        
        oscilador.start(audioContext.currentTime + index * 0.2);
        oscilador.stop(audioContext.currentTime + index * 0.2 + 0.4);
      });
    }

    function mudarNivel(novoNivel, textoNivel, titulo, descricao) {
      // Antes de mudar de n√≠vel, contabilizar a conclus√£o do n√≠vel atual (cada n√≠vel conclu√≠do = +33)
      levelAccum += 33;
      // Salvar pontua√ß√£o parcial no hist√≥rico (33 -> 33, 33+33 -> 66, etc.)
      salvarPontuacao(levelAccum);

      // Parar o jogo temporariamente
      jogoAtivo = false;
      pararCronometro();
      
      // Tocar som de celebra√ß√£o
      tocarSomNivel();
      
      // Narrar mudan√ßa de n√≠vel
      if (modoDeficienciaVisual) {
        const nivelTexto = novoNivel === 2 ? "N√≠vel 2, M√©dio" : "N√≠vel 3, Dif√≠cil";
        narrarTexto(`Parab√©ns! Voc√™ passou de n√≠vel! ${nivelTexto}. Vidas mantidas: ${vidas} de 3.`);
      }
      
      // Desabilitar bot√µes
      const botoesOpcoes = document.querySelectorAll(".botao-cor");
      botoesOpcoes.forEach(btn => btn.style.pointerEvents = "none");
      
      // Atualizar n√≠vel e resetar contador de rodadas
      nivel = novoNivel;
      rodadasPorNivel = 0;
      document.getElementById("nivel").textContent = textoNivel;
      
      // Mostrar notifica√ß√£o visual
      const notificacao = document.getElementById("notificacao");
      notificacao.innerHTML = `
        <div class="notificacao-conteudo">
          <h2>${titulo}</h2>
          <p>${descricao}</p>
          <p class="notificacao-tempo">‚è±Ô∏è Tempo resetado para 60 segundos</p>
          <p class="notificacao-vidas">‚ù§Ô∏è Vidas mantidas: ${vidas}/3</p>
        </div>
      `;
      notificacao.style.display = "flex";
      
      // Ap√≥s 3 segundos, continuar o jogo
      setTimeout(() => {
        notificacao.style.display = "none";
        tempoRestante = 60;
        jogoAtivo = true;
        iniciarCronometro();
        gerarPadrao();
      }, 3000);
    }
  </script>
</body>
</html>
